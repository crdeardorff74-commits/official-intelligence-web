<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TaNT–ØiS Admin - Official Intelligence</title>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=VT323&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/css/style.css">
    <style>
        .stat-card {
            background: rgba(0, 255, 0, 0.1);
            border: 1px solid var(--primary);
            padding: 15px;
            text-align: center;
        }
        .stat-value {
            font-family: 'Press Start 2P', cursive;
            font-size: 16px;
            color: var(--primary);
            margin-bottom: 5px;
            line-height: 1.8;
        }
        .stat-label {
            font-size: 10px;
            color: var(--text-dim);
            text-transform: uppercase;
        }
        .tab-nav {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 1px solid var(--primary);
            padding-bottom: 10px;
        }
        .tab-btn {
            background: transparent;
            border: 1px solid var(--primary);
            color: var(--primary);
            padding: 10px 20px;
            font-family: 'Press Start 2P', cursive;
            font-size: 10px;
            cursor: pointer;
        }
        .tab-btn.active {
            background: transparent;
            color: #ff8c00;
            border-color: #ff8c00;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .bug-status {
            padding: 3px 8px;
            font-size: 9px;
            border-radius: 3px;
        }
        .bug-status.new { background: #ff6b6b; color: #fff; }
        .bug-status.reviewed { background: #ffd93d; color: #000; }
        .bug-status.fixed { background: #6bcb77; color: #000; }
        .bug-status.wontfix { background: #666; color: #fff; }
        .chart-row {
            margin: 6px 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .chart-label {
            min-width: 100px;
            white-space: nowrap;
            color: var(--text-dim);
        }
        .chart-bar-bg {
            flex: 1;
            height: 16px;
            background: rgba(255,255,255,0.05);
        }
        .chart-count {
            min-width: 100px;
            text-align: right;
            color: var(--text-dim);
            white-space: nowrap;
        }
        /* Full-width override */
        main { max-width: 100% !important; width: 100% !important; padding: 1vw 2vw !important; box-sizing: border-box; }
        .visits-two-col {
            display: flex;
            gap: 2vw;
            margin-top: 20px;
        }
        .visits-left {
            flex: 1;
            min-width: 0;
        }
        .visits-right {
            flex: 1;
            min-width: 0;
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
            align-content: start;
        }
        .visits-right > div {
            min-width: 0;
        }
        #visitChallenges {
            grid-column: 1 / -1;
        }
        @media (max-width: 1200px) {
            .visits-two-col { flex-direction: column; }
            .visits-right { grid-template-columns: 1fr 1fr; }
        }
        @media (max-width: 768px) {
            .visits-right { grid-template-columns: 1fr; }
        }
        .stage-tabs {
            display: flex;
            gap: 0.3vw;
            margin-bottom: 0.8vh;
        }
        .stage-tab {
            background: rgba(0, 255, 65, 0.08);
            border: 1px solid rgba(0, 255, 65, 0.2);
            color: rgba(0, 255, 65, 0.5);
            padding: 0.3vh 0.6vw;
            cursor: pointer;
            font-family: inherit;
            font-size: 0.75em;
            transition: all 0.2s;
        }
        .stage-tab:hover {
            background: rgba(0, 255, 65, 0.15);
            color: rgba(0, 255, 65, 0.8);
        }
        .stage-tab.active {
            background: rgba(0, 255, 65, 0.2);
            border-color: var(--primary);
            color: var(--primary);
        }
        .stage-panel {
            display: none;
        }
        .stage-panel.active {
            display: block;
        }
        .rec-row {
            display: flex;
            align-items: center;
            gap: 1vw;
            padding: 0.15vh 0.8vw;
            border-bottom: 1px solid rgba(0, 255, 65, 0.07);
            font-size: 14px;
            height: 1.5em;
            line-height: 1.5em;
            overflow: visible;
        }
        .rec-row:hover {
            background: rgba(0, 255, 65, 0.05);
        }
        .rec-name {
            color: var(--primary);
            font-weight: bold;
            min-width: 12vw;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            font-family: 'Press Start 2P', cursive;
            font-size: 12px;
        }
        .rec-score {
            color: #ffc800;
            font-family: 'Press Start 2P', cursive;
            font-size: 12px;
            min-width: 6vw;
        }
        .rec-detail {
            color: var(--text-dim);
            white-space: nowrap;
            font-size: 16px;
        }
        .rec-date {
            margin-left: auto;
        }
    </style>
</head>
<body>
    <main>
        <div class="admin-header" style="display: flex; align-items: center; gap: 20px; flex-wrap: wrap;">
            <h1 style="margin: 0;">> TaNT–ØiS ADMIN</h1>
            <div class="tab-nav" id="adminTabs" style="display: none; margin: 0; border: none; padding: 0; flex: 1; justify-content: center;">
                <button class="tab-btn active" onclick="showTab('visits')"> > VISITS</button>
                <button class="tab-btn" onclick="showTab('recordings')">RECORDINGS</button>
                <button class="tab-btn" onclick="showTab('bugs')">BUG REPORTS</button>
            </div>
            <div style="display: flex; gap: 10px;">
                <button id="adminRefresh" class="btn btn-primary" style="display: none;" onclick="refreshCurrentTab()">üîÑ REFRESH</button>
                <a href="/admin/blog" class="btn btn-primary">BLOG ADMIN</a>
                <a href="/" class="btn btn-primary">‚Üê BACK TO SITE</a>
            </div>
        </div>
        
        <div id="message"></div>
        
        <div id="notAdmin" class="not-admin" style="display: none;">
            <h2 class="section-header">ACCESS DENIED</h2>
            <p style="margin-top: 20px;">Admin privileges required.</p>
            <a href="/" class="btn btn-primary" style="margin-top: 20px; display: inline-block;">RETURN HOME</a>
        </div>
        
        <div id="adminContent" style="display: none;">
            
            <!-- Recordings Tab -->
            <div id="recordingsTab" class="tab-content">
                
                <div id="recordingsStats" class="stats-grid" style="margin-bottom: 20px;">
                    <div class="loading">Loading stats...</div>
                </div>
                
                <div class="filters-row" style="margin-bottom: 15px; display: flex; gap: 10px; flex-wrap: wrap;">
                    <select id="filterPlayerType" onchange="onPlayerTypeChange()" style="padding: 8px;">
                        <option value="">All Players</option>
                        <option value="human">Human Only</option>
                        <option value="named_human">Named Human</option>
                        <option value="ai">AI Only</option>
                    </select>
                    <select id="filterPlayerName" onchange="loadRecordings()" style="padding: 8px; display: none;"></select>
                    <input type="text" id="filterUsername" placeholder="Username..." style="padding: 8px; width: 150px;">
                    <input type="number" id="filterMinScore" placeholder="Min Score" style="padding: 8px; width: 100px;">
                    <button class="btn btn-primary btn-small" onclick="loadRecordings()">FILTER</button>
                </div>
                
                <div id="recordingsList" class="posts-list">
                    <div class="loading">Loading recordings...</div>
                </div>
                
                <div id="recordingsPagination" style="margin-top: 15px; text-align: center;"></div>
            </div>
            
            <!-- Bug Reports Tab -->
            <div id="bugsTab" class="tab-content">
                
                <div class="filters-row" style="margin-bottom: 15px; display: flex; gap: 10px; flex-wrap: wrap;">
                    <select id="filterBugStatus" onchange="loadBugReports()" style="padding: 8px;">
                        <option value="">All Status</option>
                        <option value="new">New</option>
                        <option value="reviewed">Reviewed</option>
                        <option value="fixed">Fixed</option>
                        <option value="wontfix">Won't Fix</option>
                    </select>
                    <button class="btn btn-primary btn-small" onclick="loadBugReports()">FILTER</button>
                </div>
                
                <div id="bugsList" class="posts-list">
                    <div class="loading">Loading bug reports...</div>
                </div>
                
                <div id="bugsPagination" style="margin-top: 15px; text-align: center;"></div>
            </div>
        <!-- Visits Tab -->
            <div id="visitsTab" class="tab-content active">
                
                <div class="visits-two-col">
                    <div class="visits-left">
                        <div id="visitStats">
                            <div class="loading">Loading visit stats...</div>
                        </div>
                        <div id="visitChart" style="margin-top: 20px;"></div>
                        <div id="visitReferrers" style="margin-top: 20px;"></div>
                        <div id="visitLanguages" style="margin-top: 20px;"></div>
                    </div>
                    <div class="visits-right">
                        <div id="visitDevices"></div>
                        <div id="visitOS"></div>
                        <div id="visitShares"></div>
                        <div id="visitDifficulty"></div>
                        <div id="visitSkillLevel"></div>
                        <div id="visitModes"></div>
                        <div id="visitChallenges"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Bug Detail Modal -->
        <div id="bugModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 1000; overflow: auto;">
            <div style="max-width: 800px; margin: 50px auto; padding: 20px; background: #1a1a2e; border: 2px solid var(--primary);">
                <div class="admin-header">
                    <h2>> BUG REPORT #<span id="bugModalId"></span></h2>
                    <button class="btn btn-danger" onclick="closeBugModal()">‚úï CLOSE</button>
                </div>
                <div id="bugModalContent"></div>
            </div>
        </div>
    </main>
    
    <script>
        const API_URL = 'https://official-intelligence-api.onrender.com';
        const GAME_API_URL = 'https://blockchainstorm.onrender.com/api';
        let token = localStorage.getItem('oi_token');
        let currentRecordingsPage = 1;
        let currentBugsPage = 1;
        
        // Tab switching
        const tabLabels = { recordings: 'RECORDINGS', bugs: 'BUG REPORTS', visits: 'VISITS' };
        let currentActiveTab = 'visits';
        
        function showTab(tab) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
                const label = btn.textContent.replace(/^\s*>\s*/, '').trim();
                btn.textContent = label;
            });
            
            document.getElementById(tab + 'Tab').classList.add('active');
            event.target.classList.add('active');
            event.target.textContent = ' > ' + tabLabels[tab];
            currentActiveTab = tab;
            
            if (tab === 'recordings') {
                loadRecordingsStats();
                loadRecordings();
            }
            if (tab === 'bugs') {
                loadBugReports();
            }
            if (tab === 'visits') {
                loadVisitStats();
            }
        }
        
        function refreshCurrentTab() {
            if (currentActiveTab === 'recordings') {
                loadRecordingsStats();
                loadRecordings();
            } else if (currentActiveTab === 'bugs') {
                loadBugReports();
            } else if (currentActiveTab === 'visits') {
                loadVisitStats();
            }
        }
        
        // Check admin status
        async function checkAdmin() {
            if (!token) {
                document.getElementById('notAdmin').style.display = 'block';
                return;
            }
            
            try {
                const res = await fetch(`${API_URL}/auth/me`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();
                
                if (data.user?.is_admin) {
                    document.getElementById('adminContent').style.display = 'block';
                    document.getElementById('adminTabs').style.display = 'flex';
                    document.getElementById('adminRefresh').style.display = '';
                    loadVisitStats();
                } else {
                    document.getElementById('notAdmin').style.display = 'block';
                }
            } catch (err) {
                document.getElementById('notAdmin').style.display = 'block';
            }
        }
        
        // ============================================
        // GAME RECORDINGS FUNCTIONS
        // ============================================
        
        async function loadRecordingsStats() {
            try {
                const res = await fetch(`${GAME_API_URL}/admin/recordings/stats`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();
                
                if (res.ok) {
                    document.getElementById('recordingsStats').innerHTML = `
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px;">
                            <div class="stat-card">
                                <div class="stat-value">${data.total_recordings}</div>
                                <div class="stat-label">Total Recordings</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value">${data.human_recordings}</div>
                                <div class="stat-label">Human Games</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value">${data.ai_recordings}</div>
                                <div class="stat-label">AI Games</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value">${data.unique_players}</div>
                                <div class="stat-label">Unique Players</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value">${formatScore(data.human_avg_score)}</div>
                                <div class="stat-label">Human Avg</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value">${formatScore(data.ai_avg_score)}</div>
                                <div class="stat-label">AI Avg</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value">${data.last_24h}</div>
                                <div class="stat-label">Last 24h</div>
                            </div>
                        </div>
                    `;
                }
            } catch (err) {
                document.getElementById('recordingsStats').innerHTML = '<p style="color: var(--text-dim);">Failed to load stats</p>';
            }
        }
        
        async function onPlayerTypeChange() {
            const typeVal = document.getElementById('filterPlayerType').value;
            const nameDropdown = document.getElementById('filterPlayerName');
            
            if (typeVal === 'named_human') {
                try {
                    const res = await fetch(`${GAME_API_URL}/admin/recordings/named-humans`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    const data = await res.json();
                    nameDropdown.innerHTML = '<option value="">All Named</option>';
                    (data.players || []).forEach(p => {
                        nameDropdown.innerHTML += `<option value="${escapeHtml(p.name)}">${escapeHtml(p.name)} (${p.count})</option>`;
                    });
                } catch (err) {
                    nameDropdown.innerHTML = '<option value="">Failed to load</option>';
                }
                nameDropdown.style.display = '';
            } else {
                nameDropdown.style.display = 'none';
                nameDropdown.value = '';
            }
            loadRecordings();
        }

        async function loadRecordings(page = 1) {
            currentRecordingsPage = page;
            
            const playerType = document.getElementById('filterPlayerType')?.value || '';
            const playerName = document.getElementById('filterPlayerName')?.value || '';
            const username = document.getElementById('filterUsername')?.value || '';
            const minScore = document.getElementById('filterMinScore')?.value || '';
            
            let url = `${GAME_API_URL}/admin/recordings?page=${page}&per_page=15`;
            if (playerType) url += `&player_type=${playerType}`;
            if (playerName) url += `&username=${encodeURIComponent(playerName)}&exact=1`;
            else if (username) url += `&username=${encodeURIComponent(username)}`;
            if (minScore) url += `&min_score=${minScore}`;
            
            try {
                const res = await fetch(url, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();
                
                const container = document.getElementById('recordingsList');
                
                if (data.recordings?.length) {
                    container.innerHTML = data.recordings.map(rec => `
                        <div class="rec-row">
                            <span class="rec-name">${escapeHtml(rec.username)}</span>
                            <span class="rec-score">${formatScore(rec.score)}</span>
                            <span class="rec-detail">${rec.lines || 0}L ¬∑ L${rec.level || 1}</span>
                            <span class="rec-detail">${rec.difficulty} ¬∑ ${rec.skill_level}${rec.mode === 'challenge' ? ' ¬∑ CH' : ''}</span>
                            <span class="rec-detail">${Math.floor(rec.duration_seconds / 60)}m${rec.duration_seconds % 60}s</span>
                            <span class="rec-detail rec-date">${new Date(rec.played_at).toLocaleString('en-US', { timeZone: 'America/Chicago', month: 'numeric', day: 'numeric', hour: 'numeric', minute: '2-digit' })}</span>
                            <span class="rec-detail">${rec.tsunamis ? 'üåä' + rec.tsunamis : ''}${rec.blackholes ? 'üï≥Ô∏è' + rec.blackholes : ''}${rec.volcanoes ? 'üåã' + rec.volcanoes : ''}${rec.strikes ? '‚ö°' + rec.strikes : ''}</span>
                            <span class="post-status ${rec.player_type === 'human' ? 'status-published' : 'status-draft'}" style="font-size:9px;padding:2px 6px;">${rec.player_type.toUpperCase()}</span>
                            <button class="btn btn-primary btn-small" onclick="downloadRecording(${rec.id})" style="padding:2px 8px;font-size:9px;">JSON</button>
                            <button class="btn btn-danger btn-small" onclick="deleteRecording(${rec.id})" style="padding:2px 8px;font-size:9px;">DEL</button>
                        </div>
                    `).join('');
                    
                    // Pagination
                    const pagination = document.getElementById('recordingsPagination');
                    let pagHtml = '';
                    if (data.pages > 1) {
                        if (page > 1) pagHtml += `<button class="btn btn-primary btn-small" onclick="loadRecordings(${page - 1})">‚Üê PREV</button> `;
                        pagHtml += `Page ${page} of ${data.pages} (${data.total} total)`;
                        if (page < data.pages) pagHtml += ` <button class="btn btn-primary btn-small" onclick="loadRecordings(${page + 1})">NEXT ‚Üí</button>`;
                    } else {
                        pagHtml = `${data.total} recordings`;
                    }
                    pagination.innerHTML = pagHtml;
                } else {
                    container.innerHTML = '<p style="color: var(--text-dim);">No recordings found</p>';
                    document.getElementById('recordingsPagination').innerHTML = '';
                }
            } catch (err) {
                showMessage('Failed to load recordings', 'error');
            }
        }
        
        async function downloadRecording(id) {
            try {
                const res = await fetch(`${GAME_API_URL}/admin/recordings/${id}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();
                
                if (res.ok) {
                    const filename = `recording_${data.player_type}_${data.username}_${id}.json`;
                    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = filename;
                    a.click();
                    
                    URL.revokeObjectURL(url);
                } else {
                    showMessage('Failed to download recording', 'error');
                }
            } catch (err) {
                showMessage('Failed to download recording', 'error');
            }
        }
        
        async function deleteRecording(id) {
            if (!confirm('Delete this recording? This cannot be undone.')) return;
            
            try {
                const res = await fetch(`${GAME_API_URL}/admin/recordings/${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (res.ok) {
                    showMessage('Recording deleted', 'success');
                    loadRecordings(currentRecordingsPage);
                    loadRecordingsStats();
                } else {
                    showMessage('Failed to delete recording', 'error');
                }
            } catch (err) {
                showMessage('Failed to delete recording', 'error');
            }
        }
        
        // ============================================
        // BUG REPORTS FUNCTIONS
        // ============================================
        
        async function loadBugReports(page = 1) {
            currentBugsPage = page;
            
            const status = document.getElementById('filterBugStatus')?.value || '';
            
            let url = `${GAME_API_URL}/admin/bug-reports?page=${page}&per_page=20`;
            if (status) url += `&status=${status}`;
            
            try {
                const res = await fetch(url, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();
                
                const container = document.getElementById('bugsList');
                
                if (data.bug_reports?.length) {
                    container.innerHTML = data.bug_reports.map(bug => `
                        <div class="post-item">
                            <div class="post-info">
                                <h3>#${bug.id} - ${escapeHtml(bug.username)}</h3>
                                <div class="post-meta">
                                    ${new Date(bug.reported_at).toLocaleString()}
                                    ¬∑ ${bug.difficulty || 'unknown'}
                                    ¬∑ ${bug.player_type}
                                    ¬∑ Score: ${formatScore(bug.score)}
                                </div>
                                <div style="margin-top: 5px; color: var(--text-dim); font-size: 12px;">
                                    ${bug.bug_description ? escapeHtml(bug.bug_description.substring(0, 100)) + (bug.bug_description.length > 100 ? '...' : '') : '<em>No description</em>'}
                                </div>
                            </div>
                            <div style="display: flex; align-items: center; gap: 15px;">
                                <span class="bug-status ${bug.status}">${bug.status.toUpperCase()}</span>
                                <div class="post-actions">
                                    <button class="btn btn-primary btn-small" onclick="viewBugReport(${bug.id})">VIEW</button>
                                    <select onchange="updateBugStatus(${bug.id}, this.value)" style="padding: 5px; font-size: 10px;">
                                        <option value="new" ${bug.status === 'new' ? 'selected' : ''}>New</option>
                                        <option value="reviewed" ${bug.status === 'reviewed' ? 'selected' : ''}>Reviewed</option>
                                        <option value="fixed" ${bug.status === 'fixed' ? 'selected' : ''}>Fixed</option>
                                        <option value="wontfix" ${bug.status === 'wontfix' ? 'selected' : ''}>Won't Fix</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    `).join('');
                    
                    // Pagination
                    const pagination = document.getElementById('bugsPagination');
                    let pagHtml = '';
                    if (data.pages > 1) {
                        if (page > 1) pagHtml += `<button class="btn btn-primary btn-small" onclick="loadBugReports(${page - 1})">‚Üê PREV</button> `;
                        pagHtml += `Page ${page} of ${data.pages} (${data.total} total)`;
                        if (page < data.pages) pagHtml += ` <button class="btn btn-primary btn-small" onclick="loadBugReports(${page + 1})">NEXT ‚Üí</button>`;
                    } else {
                        pagHtml = `${data.total} bug reports`;
                    }
                    pagination.innerHTML = pagHtml;
                } else {
                    container.innerHTML = '<p style="color: var(--text-dim);">No bug reports found</p>';
                    document.getElementById('bugsPagination').innerHTML = '';
                }
            } catch (err) {
                showMessage('Failed to load bug reports', 'error');
            }
        }
        
        async function viewBugReport(id) {
            try {
                const res = await fetch(`${GAME_API_URL}/admin/bug-reports/${id}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const bug = await res.json();
                
                if (res.ok) {
                    document.getElementById('bugModalId').textContent = bug.id;
                    document.getElementById('bugModalContent').innerHTML = `
                        <div style="margin-bottom: 20px;">
                            <strong>User:</strong> ${escapeHtml(bug.username)}<br>
                            <strong>Reported:</strong> ${new Date(bug.reported_at).toLocaleString()}<br>
                            <strong>Status:</strong> <span class="bug-status ${bug.status}">${bug.status.toUpperCase()}</span>
                        </div>
                        
                        <div style="margin-bottom: 20px;">
                            <strong>Game State:</strong><br>
                            Difficulty: ${bug.difficulty || 'unknown'} | Skill: ${bug.skill_level || 'unknown'}<br>
                            Mode: ${bug.mode || 'normal'} | Player: ${bug.player_type}<br>
                            Score: ${formatScore(bug.score)} | Level: ${bug.level} | Lines: ${bug.lines}
                        </div>
                        
                        <div style="margin-bottom: 20px;">
                            <strong>Description:</strong>
                            <div style="background: #0a0a1a; padding: 15px; margin-top: 5px; border: 1px solid #333; white-space: pre-wrap;">
${bug.bug_description || '<em>No description provided</em>'}
                            </div>
                        </div>
                        
                        <div>
                            <strong>Debug Log:</strong>
                            <div style="background: #0a0a1a; padding: 15px; margin-top: 5px; border: 1px solid #333; max-height: 400px; overflow: auto; font-family: monospace; font-size: 11px; white-space: pre;">
${bug.debug_log ? escapeHtml(bug.debug_log) : '<em>No debug log</em>'}
                            </div>
                        </div>
                        
                        <div style="margin-top: 20px;">
                            <button class="btn btn-primary" onclick="downloadBugLog(${bug.id})">‚¨áÔ∏è DOWNLOAD LOG</button>
                        </div>
                    `;
                    document.getElementById('bugModal').style.display = 'block';
                }
            } catch (err) {
                showMessage('Failed to load bug report', 'error');
            }
        }
        
        function closeBugModal() {
            document.getElementById('bugModal').style.display = 'none';
        }
        
        async function updateBugStatus(id, status) {
            try {
                const res = await fetch(`${GAME_API_URL}/admin/bug-reports/${id}/status`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ status })
                });
                
                if (res.ok) {
                    showMessage('Status updated', 'success');
                    loadBugReports(currentBugsPage);
                } else {
                    showMessage('Failed to update status', 'error');
                }
            } catch (err) {
                showMessage('Failed to update status', 'error');
            }
        }
        
        async function downloadBugLog(id) {
            try {
                const res = await fetch(`${GAME_API_URL}/admin/bug-reports/${id}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const bug = await res.json();
                
                if (res.ok && bug.debug_log) {
                    const filename = `bug_${id}_${bug.username}_log.txt`;
                    const content = `Bug Report #${id}\n` +
                        `User: ${bug.username}\n` +
                        `Reported: ${bug.reported_at}\n` +
                        `Status: ${bug.status}\n` +
                        `Difficulty: ${bug.difficulty}\n` +
                        `Skill: ${bug.skill_level}\n` +
                        `Score: ${bug.score}\n` +
                        `\nDescription:\n${bug.bug_description || 'None'}\n` +
                        `\n${'='.repeat(50)}\nDEBUG LOG:\n${'='.repeat(50)}\n\n` +
                        bug.debug_log;
                    
                    const blob = new Blob([content], { type: 'text/plain' });
                    const url = URL.createObjectURL(blob);
                    
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = filename;
                    a.click();
                    
                    URL.revokeObjectURL(url);
                }
            } catch (err) {
                showMessage('Failed to download log', 'error');
            }
        }
        
        // ============================================
        // UTILITY FUNCTIONS
        // ============================================
        
        function showMessage(text, type) {
            const el = document.getElementById('message');
            el.innerHTML = `<div class="message ${type}">${text}</div>`;
            setTimeout(() => el.innerHTML = '', 3000);
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        function switchStageTab(btn, group) {
            document.querySelectorAll(`.stage-tab[onclick*="'${group}'"]`).forEach(t => t.classList.remove('active'));
            document.querySelectorAll(`.stage-panel[data-group="${group}"]`).forEach(p => p.classList.remove('active'));
            btn.classList.add('active');
            const stage = btn.getAttribute('data-stage');
            document.querySelector(`.stage-panel[data-group="${group}"][data-stage="${stage}"]`).classList.add('active');
        }
        
        function formatScore(score) {
            if (!score) return '‚Çø0.0000';
            const btc = score / 10000000;
            return `‚Çø${btc.toFixed(4)}`;
        }
        
        // Close modal on ESC
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeBugModal();
            }
        });
        
        // ============================================
        // VISIT TRACKING FUNCTIONS
        // ============================================
        
        async function loadVisitStats() {
            try {
                const res = await fetch(`${GAME_API_URL}/admin/visits/stats?_=${Date.now()}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();
                
                if (res.ok) {
                    // Summary stats
                    document.getElementById('visitStats').innerHTML = `
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(130px, 1fr)); gap: 15px;">
                            <div class="stat-card">
                                <div class="stat-value">${data.total_visits}</div>
                                <div class="stat-label">Total Visits</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value">${data.total_started}</div>
                                <div class="stat-label">Started Game</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value">${data.total_finished}</div>
                                <div class="stat-label">Finished Game</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value">${data.total_shared}</div>
                                <div class="stat-label">Shared Game</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value">${data.start_rate}% <span style="white-space:nowrap;">‚Üí&nbsp;${data.finish_rate}%</span> <span style="white-space:nowrap;">‚Üí&nbsp;${data.share_rate}%</span></div>
                                <div class="stat-label">Start / Finish / Share Rate</div>
                            </div>
                        </div>
                    `;
                    
                    // Daily chart (text-based bar chart)
                    if (data.daily_visits && data.daily_visits.length > 0) {
                        const maxVisits = Math.max(...data.daily_visits.map(d => d.visits));
                        const barWidth = maxVisits > 0 ? 100 / maxVisits : 0;
                        
                        let chartHtml = '<h3 style="margin-bottom: 10px; color: var(--primary);">> Daily Visits (30 days)</h3>';
                        chartHtml += '<div style="font-family: monospace; font-size: 12px;">';
                        data.daily_visits.forEach(d => {
                            const visitBar = Math.round(d.visits * barWidth);
                            const startedBar = Math.round(d.started * barWidth);
                            const finishedBar = Math.round(d.finished * barWidth);
                            const date = d.day.substring(5); // MM-DD
                            chartHtml += `<div style="margin: 2px 0; display: flex; align-items: center; gap: 8px;">
                                <span style="width: 50px; color: var(--text-dim);">${date}</span>
                                <div style="flex: 1; position: relative; height: 16px; background: rgba(255,255,255,0.05);">
                                    <div style="position: absolute; height: 100%; width: ${visitBar}%; background: rgba(0,150,255,0.4);"></div>
                                    <div style="position: absolute; height: 100%; width: ${startedBar}%; background: rgba(255,200,0,0.5);"></div>
                                    <div style="position: absolute; height: 100%; width: ${finishedBar}%; background: rgba(255,80,80,0.6);"></div>
                                    <div style="position: absolute; height: 100%; width: ${Math.round((d.shared || 0) * barWidth)}%; background: rgba(180,80,255,0.6);"></div>
                                </div>
                                <span style="width: 140px; text-align: right; color: var(--text-dim);">${d.visits}/${d.started}/${d.finished}/${d.shared || 0}</span>
                            </div>`;
                        });
                        chartHtml += '</div>';
                        chartHtml += '<div style="margin-top: 5px; font-size: 11px; color: var(--text-dim);"><span style="color: rgba(0,150,255,0.7);">‚ñ†</span> Visits &nbsp; <span style="color: rgba(255,200,0,0.8);">‚ñ†</span> Started &nbsp; <span style="color: rgba(255,80,80,0.8);">‚ñ†</span> Finished &nbsp; <span style="color: rgba(180,80,255,0.8);">‚ñ†</span> Shared</div>';
                        document.getElementById('visitChart').innerHTML = chartHtml;
                    }
                    
                    // Top referrers
                    if (data.top_referrers && data.top_referrers.length > 0) {
                        let refHtml = '<h3 style="margin-bottom: 10px; color: var(--primary);">> Top Referrers</h3>';
                        refHtml += '<table style="width: 100%; border-collapse: collapse;">';
                        refHtml += '<tr style="border-bottom: 1px solid var(--primary);"><th style="text-align: left; padding: 5px;">Referrer</th><th style="text-align: right; padding: 5px;">Visits</th><th style="text-align: right; padding: 5px;">Started</th><th style="text-align: right; padding: 5px;">Finished</th><th style="text-align: right; padding: 5px;">Conv%</th></tr>';
                        data.top_referrers.forEach(r => {
                            const conv = r.visits > 0 ? (r.finished / r.visits * 100).toFixed(1) : '0.0';
                            // Truncate long referrers
                            const shortRef = r.referrer.length > 60 ? r.referrer.substring(0, 60) + '...' : r.referrer;
                            refHtml += `<tr style="border-bottom: 1px solid rgba(255,255,255,0.1);"><td style="padding: 5px; color: var(--text-dim); word-break: break-all;">${escapeHtml(shortRef)}</td><td style="text-align: right; padding: 5px;">${r.visits}</td><td style="text-align: right; padding: 5px;">${r.started}</td><td style="text-align: right; padding: 5px;">${r.finished}</td><td style="text-align: right; padding: 5px;">${conv}%</td></tr>`;
                        });
                        refHtml += '</table>';
                        document.getElementById('visitReferrers').innerHTML = refHtml;
                    }
                    
                    // Top languages
                    if (data.top_languages && data.top_languages.length > 0) {
                        let langHtml = '<h3 style="margin-bottom: 10px; color: var(--primary);">> Top Languages</h3>';
                        langHtml += '<table style="width: 100%; border-collapse: collapse;">';
                        langHtml += '<tr style="border-bottom: 1px solid var(--primary);"><th style="text-align: left; padding: 5px;">Language</th><th style="text-align: right; padding: 5px;">Visits</th><th style="text-align: right; padding: 5px;">Started</th><th style="text-align: right; padding: 5px;">Finished</th><th style="text-align: right; padding: 5px;">Conv%</th></tr>';
                        data.top_languages.forEach(l => {
                            const conv = l.visits > 0 ? (l.finished / l.visits * 100).toFixed(1) : '0.0';
                            langHtml += `<tr style="border-bottom: 1px solid rgba(255,255,255,0.1);"><td style="padding: 5px;">${escapeHtml(l.language)}</td><td style="text-align: right; padding: 5px;">${l.visits}</td><td style="text-align: right; padding: 5px;">${l.started}</td><td style="text-align: right; padding: 5px;">${l.finished}</td><td style="text-align: right; padding: 5px;">${conv}%</td></tr>`;
                        });
                        langHtml += '</table>';
                        document.getElementById('visitLanguages').innerHTML = langHtml;
                    }

                    // Device type breakdown (per funnel stage)
                    if (data.device_breakdown) {
                        const deviceColors = { desktop: '#0096ff', tablet: '#00ff64', phone: '#ffc800' };
                        const deviceIcons = { desktop: 'üñ•Ô∏è', tablet: 'üì±', phone: 'üì≤' };
                        const stages = ['visit', 'start', 'finish', 'share'];
                        const stageLabels = { visit: 'Visit', start: 'Start', finish: 'Finish', share: 'Share' };
                        let deviceHtml = '<h3 style="margin-bottom: 10px; color: var(--primary);">> Devices</h3>';
                        deviceHtml += '<div class="stage-tabs" data-group="devices">';
                        stages.forEach((s, i) => {
                            deviceHtml += `<button class="stage-tab${i === 0 ? ' active' : ''}" data-stage="${s}" onclick="switchStageTab(this, 'devices')">${stageLabels[s]}</button>`;
                        });
                        deviceHtml += '</div>';
                        stages.forEach((stage, i) => {
                            const items = data.device_breakdown[stage] || [];
                            const total = items.reduce((s, d) => s + d.count, 0);
                            deviceHtml += `<div class="stage-panel${i === 0 ? ' active' : ''}" data-group="devices" data-stage="${stage}">`;
                            if (items.length === 0) {
                                deviceHtml += '<div style="color: #666; padding: 5px;">No data</div>';
                            } else {
                                items.sort((a, b) => b.count - a.count);
                                items.forEach(d => {
                                    const pct = (d.count / total * 100).toFixed(1);
                                    const color = deviceColors[d.type] || '#888';
                                    const icon = deviceIcons[d.type] || '';
                                    deviceHtml += `<div class="chart-row">
                                        <span class="chart-label">${icon} ${d.type}</span>
                                        <div class="chart-bar-bg">
                                            <div style="height: 100%; width: ${pct}%; background: ${color}; opacity: 0.6;"></div>
                                        </div>
                                        <span class="chart-count">${d.count} (${pct}%)</span>
                                    </div>`;
                                });
                            }
                            deviceHtml += '</div>';
                        });
                        document.getElementById('visitDevices').innerHTML = deviceHtml;
                    }

                    // OS breakdown (per funnel stage)
                    if (data.os_breakdown) {
                        const osColors = { Windows: '#0078d4', iOS: '#a2aaad', Android: '#3ddc84', macOS: '#555', Linux: '#f5a623', Other: '#888' };
                        const stages = ['visit', 'start', 'finish', 'share'];
                        const stageLabels = { visit: 'Visit', start: 'Start', finish: 'Finish', share: 'Share' };
                        let osHtml = '<h3 style="margin-bottom: 10px; color: var(--primary);">> Operating Systems</h3>';
                        osHtml += '<div class="stage-tabs" data-group="os">';
                        stages.forEach((s, i) => {
                            osHtml += `<button class="stage-tab${i === 0 ? ' active' : ''}" data-stage="${s}" onclick="switchStageTab(this, 'os')">${stageLabels[s]}</button>`;
                        });
                        osHtml += '</div>';
                        stages.forEach((stage, i) => {
                            const items = data.os_breakdown[stage] || [];
                            const total = items.reduce((s, o) => s + o.count, 0);
                            osHtml += `<div class="stage-panel${i === 0 ? ' active' : ''}" data-group="os" data-stage="${stage}">`;
                            if (items.length === 0) {
                                osHtml += '<div style="color: #666; padding: 5px;">No data</div>';
                            } else {
                                items.sort((a, b) => b.count - a.count);
                                items.forEach(o => {
                                    const pct = (o.count / total * 100).toFixed(1);
                                    const color = osColors[o.os] || '#888';
                                    osHtml += `<div class="chart-row">
                                        <span class="chart-label">${escapeHtml(o.os)}</span>
                                        <div class="chart-bar-bg">
                                            <div style="height: 100%; width: ${pct}%; background: ${color}; opacity: 0.6;"></div>
                                        </div>
                                        <span class="chart-count">${o.count} (${pct}%)</span>
                                    </div>`;
                                });
                            }
                            osHtml += '</div>';
                        });
                        document.getElementById('visitOS').innerHTML = osHtml;
                    }

                    // Share platform breakdown
                    if (data.share_breakdown && data.share_breakdown.length > 0) {
                        const totalShares = data.share_breakdown.reduce((s, d) => s + d.count, 0);
                        const shareColors = { twitter: '#1DA1F2', facebook: '#4267B2', reddit: '#FF4500', whatsapp: '#25D366', telegram: '#0088cc', copylink: '#888' };
                        const shareIcons = { twitter: 'ùïè', facebook: 'f', reddit: '‚¨Ü', whatsapp: 'üí¨', telegram: '‚úà', copylink: 'üîó' };
                        let shareHtml = '<h3 style="margin-bottom: 10px; color: var(--primary);">> Share Platforms</h3>';
                        data.share_breakdown.forEach(d => {
                            const pct = (d.count / totalShares * 100).toFixed(1);
                            const color = shareColors[d.platform] || '#888';
                            const icon = shareIcons[d.platform] || '';
                            shareHtml += `<div class="chart-row">
                                <span class="chart-label">${icon} ${d.platform}</span>
                                <div class="chart-bar-bg">
                                    <div style="height: 100%; width: ${pct}%; background: ${color}; opacity: 0.6;"></div>
                                </div>
                                <span class="chart-count">${d.count} (${pct}%)</span>
                            </div>`;
                        });
                        document.getElementById('visitShares').innerHTML = shareHtml;
                    }

                    // Difficulty breakdown
                    if (data.difficulty_breakdown && data.difficulty_breakdown.length > 0) {
                        const totalDiff = data.difficulty_breakdown.reduce((s, d) => s + d.count, 0);
                        const diffColors = { drizzle: '#52B788', downpour: '#45B7D1', hailstorm: '#FFD93D', blizzard: '#FF6B6B', hurricane: '#C084FC' };
                        const diffIcons = { drizzle: 'üåßÔ∏è', downpour: '‚õàÔ∏è', hailstorm: 'üå®Ô∏è', blizzard: '‚ùÑÔ∏è', hurricane: 'üåÄ' };
                        let diffHtml = '<h3 style="margin-bottom: 10px; color: var(--primary);">> Difficulty</h3>';
                        data.difficulty_breakdown.forEach(d => {
                            const pct = (d.count / totalDiff * 100).toFixed(1);
                            const color = diffColors[d.difficulty] || '#888';
                            const icon = diffIcons[d.difficulty] || '';
                            diffHtml += `<div class="chart-row">
                                <span class="chart-label">${icon} ${d.difficulty}</span>
                                <div class="chart-bar-bg">
                                    <div style="height: 100%; width: ${pct}%; background: ${color}; opacity: 0.6;"></div>
                                </div>
                                <span class="chart-count">${d.count} (${pct}%)</span>
                            </div>`;
                        });
                        document.getElementById('visitDifficulty').innerHTML = diffHtml;
                    }

                    // Skill level breakdown
                    if (data.skill_breakdown && data.skill_breakdown.length > 0) {
                        const totalSkill = data.skill_breakdown.reduce((s, d) => s + d.count, 0);
                        const skillColors = { breeze: '#52B788', tempest: '#FFD93D', maelstrom: '#FF6B6B' };
                        const skillIcons = { breeze: 'üå§Ô∏è', tempest: 'üå™Ô∏è', maelstrom: 'üåÄ' };
                        let skillHtml = '<h3 style="margin-bottom: 10px; color: var(--primary);">> Skill Level</h3>';
                        data.skill_breakdown.forEach(d => {
                            const pct = (d.count / totalSkill * 100).toFixed(1);
                            const color = skillColors[d.skill_level] || '#888';
                            const icon = skillIcons[d.skill_level] || '';
                            skillHtml += `<div class="chart-row">
                                <span class="chart-label">${icon} ${d.skill_level}</span>
                                <div class="chart-bar-bg">
                                    <div style="height: 100%; width: ${pct}%; background: ${color}; opacity: 0.6;"></div>
                                </div>
                                <span class="chart-count">${d.count} (${pct}%)</span>
                            </div>`;
                        });
                        document.getElementById('visitSkillLevel').innerHTML = skillHtml;
                    }

                    // Mode breakdown
                    if (data.mode_breakdown && data.mode_breakdown.length > 0) {
                        const totalMode = data.mode_breakdown.reduce((s, d) => s + d.count, 0);
                        const modeColors = { normal: '#45B7D1', challenge: '#FFD93D', ai: '#C084FC', 'ai-challenge': '#FF6B6B' };
                        const modeIcons = { normal: 'üéÆ', challenge: 'üèÜ', ai: 'ü§ñ', 'ai-challenge': 'ü§ñüèÜ' };
                        let modeHtml = '<h3 style="margin-bottom: 10px; color: var(--primary);">> Game Mode</h3>';
                        data.mode_breakdown.forEach(d => {
                            const pct = (d.count / totalMode * 100).toFixed(1);
                            const color = modeColors[d.mode] || '#888';
                            const icon = modeIcons[d.mode] || '';
                            modeHtml += `<div class="chart-row">
                                <span class="chart-label">${icon} ${d.mode}</span>
                                <div class="chart-bar-bg">
                                    <div style="height: 100%; width: ${pct}%; background: ${color}; opacity: 0.6;"></div>
                                </div>
                                <span class="chart-count">${d.count} (${pct}%)</span>
                            </div>`;
                        });
                        document.getElementById('visitModes').innerHTML = modeHtml;
                    }

                    // Challenge breakdown
                    if (data.challenge_breakdown && data.challenge_breakdown.length > 0) {
                        const totalChal = data.challenge_breakdown.reduce((s, d) => s + d.count, 0);
                        const chalColors = {
                            stranger: '#FF6B6B', dyslexic: '#C084FC', phantom: '#45B7D1',
                            rubber: '#FFD93D', oz: '#52B788', thinner: '#FF8C00', thicker: '#E8596A',
                            carrie: '#DC143C', nokings: '#8B6914', longago: '#B8860B', comingsoon: '#00CED1',
                            nervous: '#FF69B4', sixseven: '#7B68EE', gremlins: '#32CD32',
                            lattice: '#DDA0DD', yesand: '#20B2AA', mercurial: '#CD853F',
                            shadowless: '#708090', sorandom: '#FF1493'
                        };
                        let chalHtml = '<h3 style="margin-bottom: 10px; color: var(--primary);">> Challenges Played</h3>';
                        data.challenge_breakdown.forEach(d => {
                            const pct = (d.count / totalChal * 100).toFixed(1);
                            const color = chalColors[d.challenge] || '#888';
                            chalHtml += `<div class="chart-row">
                                <span class="chart-label">${d.challenge}</span>
                                <div class="chart-bar-bg">
                                    <div style="height: 100%; width: ${pct}%; background: ${color}; opacity: 0.6;"></div>
                                </div>
                                <span class="chart-count">${d.count} (${pct}%)</span>
                            </div>`;
                        });
                        document.getElementById('visitChallenges').innerHTML = chalHtml;
                    }
                }
            } catch (err) {
                document.getElementById('visitStats').innerHTML = '<p style="color: var(--text-dim);">Failed to load visit stats</p>';
            }
        }
        
        // Init
        checkAdmin();
    </script>
</body>
</html>
